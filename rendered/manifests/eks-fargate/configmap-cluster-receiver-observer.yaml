---
# Source: splunk-otel-collector/templates/configmap-cluster-receiver-observer.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: default-splunk-otel-collector-otel-eks-fargate-cluster-receiver-observer
  labels:
    app.kubernetes.io/name: splunk-otel-collector
    helm.sh/chart: splunk-otel-collector-0.41.0
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/instance: default
    app.kubernetes.io/version: "0.41.0"
    app: splunk-otel-collector
    chart: splunk-otel-collector-0.41.0
    release: default
    heritage: Helm
data:
  relay: |
    exporters:
      signalfx:
        access_token: ${SPLUNK_OBSERVABILITY_ACCESS_TOKEN}
        api_url: http://default-splunk-otel-collector:6060
        ingest_url: http://default-splunk-otel-collector:9943
        timeout: 10s
    extensions:
      health_check: null
      k8s_observer:
        auth_type: serviceAccount
        observe_nodes: true
        observe_pods: false
      memory_ballast:
        size_mib: ${SPLUNK_BALLAST_SIZE_MIB}
    processors:
      batch: null
      memory_limiter:
        check_interval: 2s
        limit_mib: ${SPLUNK_MEMORY_LIMIT_MIB}
      resource:
        attributes:
        - action: insert
          key: metric_source
          value: kubernetes
        - action: insert
          key: receiver
          value: k8scluster
        - action: upsert
          key: k8s.cluster.name
          value: CHANGEME
        - action: extract
          key: container.image.name
          pattern: ^(?P<temp_container_image_name>[^\:]+)(?:\:(?P<temp_container_image_tag>.*))?
        - action: upsert
          from_attribute: temp_container_image_name
          key: container.image.name
        - action: delete
          key: temp_container_image_name
        - action: upsert
          from_attribute: temp_container_image_tag
          key: container.image.tag
        - action: delete
          key: temp_container_image_tag
      resource/add_collector_k8s:
        attributes:
        - action: insert
          key: k8s.node.name
          value: ${K8S_NODE_NAME}
        - action: insert
          key: k8s.pod.name
          value: ${K8S_POD_NAME}
        - action: insert
          key: k8s.pod.uid
          value: ${K8S_POD_UID}
        - action: insert
          key: k8s.namespace.name
          value: ${K8S_NAMESPACE}
      resourcedetection:
        detectors:
        - env
        - eks
        - ec2
        - system
        override: false
        timeout: 10s
    receivers:
      prometheus/k8s_cluster_receiver:
        config:
          scrape_configs:
          - job_name: otel-k8s-cluster-receiver-observer
            scrape_interval: 10s
            static_configs:
            - targets:
              - ${K8S_POD_IP}:8889
      receiver_creator/eks-fargate-cluster-receiver:
        receivers:
          kubeletstats:
            config:
              auth_type: serviceAccount
              collection_interval: 10s
              endpoint: '`endpoint`:`kubelet_endpoint_port`'
              extra_metadata_labels:
              - container.id
              metric_groups:
              - container
              - pod
              - node
            rule: type == "k8s.node" && name contains "fargate" && labels["splunk-otel-is-eks-fargate-cluster-receiver-node"] == "true"
        watch_observers:
        - k8s_observer
    service:
      extensions:
      - health_check
      - memory_ballast
      - k8s_observer
      pipelines:
        metrics:
          exporters:
          - signalfx
          processors:
          - memory_limiter
          - batch
          - resource
          receivers:
          - receiver_creator/eks-fargate-cluster-receiver
        metrics/collector:
          exporters:
          - signalfx
          processors:
          - memory_limiter
          - batch
          - resource
          - resource/add_collector_k8s
          - resourcedetection
          receivers:
          - prometheus/k8s_cluster_receiver
